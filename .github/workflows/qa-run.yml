name: Run Ecosystem QA
on:
  repository_dispatch:
    types: [qa-run]
  workflow_dispatch:
    inputs:
      repo:
        required: true
      tag:
        required: true
      artifact_name:
        required: true

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Script Deps
        run: pip install requests

      # --- NEW: Generate a Universal Token ---
      - name: Generate App Token
        id: app_token
        uses: actions/create-github-app-token@v1
        with:
          # Use the Org Secrets we configured earlier
          app-id: ${{ secrets.QA_APP_ID }}
          private-key: ${{ secrets.QA_APP_PRIVATE_KEY }}
          owner: novaeco-tech 
          # This token now has Read/Write access to ALL repos where the app is installed

      # 1. Set Inputs
      - name: Set Inputs
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "REPO=${{ github.event.client_payload.repo }}" >> $GITHUB_ENV
            echo "TAG=${{ github.event.client_payload.tag }}" >> $GITHUB_ENV
            echo "ARTIFACT=${{ github.event.client_payload.artifact_name }}" >> $GITHUB_ENV
          else
            echo "REPO=${{ inputs.repo }}" >> $GITHUB_ENV
            echo "TAG=${{ inputs.tag }}" >> $GITHUB_ENV
            echo "ARTIFACT=${{ inputs.artifact_name }}" >> $GITHUB_ENV
          fi

      # 2. Determine Service Configuration
      - name: Configure Service
        id: config
        run: |
          PORT=8000
          CMD="python main.py"
          HEALTH_PATH="/health"

          if [[ "${{ env.ARTIFACT }}" == *"website"* ]]; then
             PORT=3000
             CMD="python -m http.server 3000"
             HEALTH_PATH="/"
          elif [[ "${{ env.ARTIFACT }}" == *"app"* ]]; then
             PORT=5000
             CMD="python app.py"
             HEALTH_PATH="/"
          elif [[ "${{ env.ARTIFACT }}" == *"auth"* ]]; then
             PORT=9000
             CMD="python main.py"
             HEALTH_PATH="/health"
          fi

          echo "PORT=$PORT" >> $GITHUB_ENV
          echo "CMD=$CMD" >> $GITHUB_ENV
          echo "HEALTH_PATH=$HEALTH_PATH" >> $GITHUB_ENV

      # 3. Download Artifact (Using App Token)
      - name: Download Artifact
        run: |
          mkdir -p build_ctx
          python3 scripts/fetch_artifact.py \
            --repo ${{ env.REPO }} \
            --tag ${{ env.TAG }} \
            --artifact ${{ env.ARTIFACT }} \
            --output-dir build_ctx
        env:
          GITHUB_TOKEN: ${{ steps.app_token.outputs.token }}

      # 4. Build & Run
      - name: Start Service
        run: |
          cp environments/Dockerfile.template build_ctx/Dockerfile
          docker build -t test-service build_ctx
          docker run -d -p ${{ env.PORT }}:${{ env.PORT }} \
            --name test-container \
            test-service \
            sh -c "${{ env.CMD }}"
          sleep 10

      # 5. Verify
      - name: Health Check
        run: |
          URL="http://localhost:${{ env.PORT }}${{ env.HEALTH_PATH }}"
          echo "Checking $URL..."
          if curl -s --fail "$URL"; then
            echo "✅ Service is healthy!"
          else
             echo "❌ Service failed."
             docker logs test-container
             exit 1
          fi

      # 6. Promote Release (Using App Token)
      - name: Promote Release
        if: success()
        run: |
          echo "Promoting ${{ env.TAG }} to Stable..."
          
          # Use the high-level command which handles IDs automatically
          gh release edit "${{ env.TAG }}" \
            --repo "novaeco-tech/${{ env.REPO }}" \
            --prerelease=false \
            --latest
        env:
          # Use the App Token we generated at the start
          GITHUB_TOKEN: ${{ steps.app_token.outputs.token }}